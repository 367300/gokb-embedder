# Архитектура GoKB Embedder

## Обзор

GoKB Embedder — это модульное приложение на Go для создания эмбедингов из кодовой базы. Проект следует принципам чистой архитектуры и разделения ответственности.

## Архитектурные принципы

1. **Разделение ответственности** — каждый модуль отвечает за свою область
2. **Инверсия зависимостей** — зависимости направлены внутрь, к бизнес-логике
3. **Расширяемость** — легко добавлять новые парсеры и функциональность
4. **Тестируемость** — каждый компонент можно тестировать изолированно
5. **Конфигурируемость** — все настройки вынесены в конфигурацию

## Структура проекта

```
gokb-embedder/
├── cmd/                    # Точка входа
│   └── main.go
├── internal/               # Внутренние модули
│   ├── app/               # Основная логика приложения
│   ├── config/            # Конфигурация
│   ├── database/          # Работа с базой данных
│   ├── git/               # Работа с Git
│   ├── models/            # Модели данных
│   ├── openai/            # OpenAI API клиент
│   ├── parsers/           # Парсеры файлов
│   ├── scanner/           # Сканирование файлов
│   └── utils/             # Утилиты
├── examples/              # Примеры использования
└── docs/                  # Документация
```

## Слои архитектуры

### 1. Слой представления (Presentation Layer)
- **cmd/main.go** — точка входа в приложение
- Обработка аргументов командной строки
- Инициализация и запуск приложения

### 2. Слой приложения (Application Layer)
- **internal/app/** — основная логика приложения
- Координация между компонентами
- Управление жизненным циклом приложения

### 3. Слой домена (Domain Layer)
- **internal/models/** — модели данных
- **internal/parsers/** — интерфейсы и реестр парсеров
- Бизнес-логика и правила

### 4. Слой инфраструктуры (Infrastructure Layer)
- **internal/database/** — работа с базой данных
- **internal/openai/** — OpenAI API клиент
- **internal/git/** — работа с Git
- **internal/scanner/** — сканирование файлов
- **internal/utils/** — утилиты

## Ключевые компоненты

### App (internal/app/app.go)
Центральный компонент, который координирует работу всех остальных модулей.

**Ответственности:**
- Инициализация всех компонентов
- Координация процесса обработки файлов
- Управление жизненным циклом приложения
- Обработка ошибок и логирование

**Зависимости:**
- config.Config
- database.Database
- openai.Client
- scanner.Scanner
- parsers.ParserRegistry
- git.GitService

### ParserRegistry (internal/parsers/parser.go)
Реестр всех доступных парсеров файлов.

**Ответственности:**
- Регистрация парсеров
- Поиск подходящего парсера для файла
- Управление жизненным циклом парсеров

**Интерфейс Parser:**
```go
type Parser interface {
    ParseFile(filePath string) ([]*models.CodeBlock, error)
    CanParse(fileExtension string) bool
    GetName() string
}
```

### CodeBlock (internal/models/codeblock.go)
Модель данных для представления блоков кода.

**Поля:**
- FilePath — путь к файлу
- BlockType — тип блока (method, function, markdown, etc.)
- ClassName — имя класса (для методов)
- MethodName — имя метода/функции
- StartLine, EndLine — диапазон строк
- RawText — исходный текст
- CommitMessages — сообщения коммитов

### Database (internal/database/database.go)
Абстракция для работы с базой данных SQLite.

**Ответственности:**
- Создание и инициализация таблиц
- Сохранение и получение эмбедингов
- Управление хешами файлов
- Проверка существования блоков

### Scanner (internal/scanner/scanner.go)
Сканирование файлов с поддержкой .gitignore.

**Ответственности:**
- Рекурсивное сканирование директорий
- Фильтрация по расширениям файлов
- Применение правил .gitignore
- Получение относительных путей

## Поток данных

```
1. main.go → App.Run()
2. App.initialize() → инициализация всех компонентов
3. App.scanFiles() → Scanner.ScanFiles()
4. App.checkFileChanges() → Database.GetFileHash()
5. App.processFiles() → Parser.ParseFile()
6. App.createEmbeddings() → OpenAI.GetEmbedding()
7. Database.SaveEmbedding() → сохранение в БД
```

## Расширяемость

### Добавление нового парсера

1. Создать новый файл в `internal/parsers/`
2. Реализовать интерфейс `Parser`
3. Зарегистрировать в `App.registerParsers()`

Пример:
```go
type GoParser struct{}

func (gp *GoParser) GetName() string {
    return "go"
}

func (gp *GoParser) CanParse(fileExtension string) bool {
    return fileExtension == ".go"
}

func (gp *GoParser) ParseFile(filePath string) ([]*models.CodeBlock, error) {
    // Реализация парсинга
}
```

### Добавление новой базы данных

1. Создать новый файл в `internal/database/`
2. Реализовать интерфейс `Database`
3. Обновить `App.initialize()`

### Добавление нового API клиента

1. Создать новый файл в `internal/`
2. Реализовать интерфейс клиента
3. Обновить `App.initialize()`

## Обработка ошибок

Приложение использует многоуровневую обработку ошибок:

1. **Логирование** — все ошибки логируются с контекстом
2. **Продолжение работы** — ошибки в отдельных файлах не останавливают процесс
3. **Graceful degradation** — приложение продолжает работать даже при частичных сбоях
4. **Информативные сообщения** — пользователь получает понятные сообщения об ошибках

## Конфигурация

Конфигурация загружается из:
1. Переменных окружения
2. Файла .env
3. Значений по умолчанию

Все настройки централизованы в `internal/config/config.go`.

## Тестирование

Каждый компонент имеет свои тесты:
- Модульные тесты для каждой функции
- Интеграционные тесты для взаимодействия компонентов
- Тесты производительности для критических путей

## Производительность

Оптимизации:
- Умное обновление — только изменённые файлы
- Пакетные операции с базой данных
- Кэширование результатов
- Асинхронная обработка где возможно
- Прогресс-бары для отслеживания процесса

## Безопасность

- Валидация входных данных
- Безопасная работа с файловой системой
- Защита от SQL-инъекций
- Безопасное хранение API ключей
- Логирование без чувствительных данных 